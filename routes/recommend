const express = require("express");
const router = express.Router();   // âœ… THIS LINE WAS MISSING
const Destination = require("../models/Destination");

router.post("/recommend", async (req, res) => {
  try {
    let { climate, budget, activities, duration } = req.body;

    // ðŸ” NORMALIZATION (Frontend â†’ Backend)
const climateMap = {
  "ðŸŒ¿ Monsoon Escape": "moderate",
  "ðŸŒ¤ï¸ Mild & Pleasant": "moderate",
  "â˜€ï¸ Warm & Sunny": "hot",
  "â„ï¸ Cool & Mountain": "cold"
};

const budgetMap = {
  "ðŸ’¸ Budget-Friendly": "low",
  "ðŸ’¼ Comfortable": "medium",
  "âœ¨ Premium": "high"
};

const durationMap = {
  "Weekend": "weekend",
  "3â€“7 days": "3-7 days",
  "3-7 days": "3-7 days",
  "Long stay": "long stay"
};

const activityMap = {
  "Beach": "beach",
  "Trekking": "trekking",
  "Adventure": "adventure",
  "Culture": "culture"
};

// Apply normalization
climate = climateMap[climate] || climate;
budget = budgetMap[budget] || budget;
duration = durationMap[duration] || duration;
activities = activities?.map(a => activityMap[a] || a);


    // Normalize values
    climate = climateMap[climate] || climate;
    budget = budgetMap[budget] || budget;
    activities = activities?.map(a => activityMap[a] || a);
    duration = duration?.toLowerCase();

    // ðŸ” Build query dynamically
    let query = {};

    if (climate) query.climate = climate;
    if (budget) query.budget = budget;
    if (duration) query.duration = duration;
    if (activities && activities.length > 0) {
      query.activities = { $in: activities };
    }

    const results = await Destination.find(query);

    res.json(results);   // âœ… Always return array
  } catch (error) {
    console.error(error);
    res.status(500).json({ message: "Internal server error" });
  }
});

module.exports = router;   // âœ… ALSO REQUIRED
